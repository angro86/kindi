<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kindi - Educational Videos for Kids</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Nunito', sans-serif; }
    .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef } = React;

// Icons
const Play = ({className}) => <svg className={className} viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"/></svg>;
const Pause = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>;
const Clock = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
const Star = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
const Plus = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
const X = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
const ArrowLeft = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>;
const Trophy = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
const Volume2 = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>;
const Sparkles = ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3L12 3Z"/></svg>;

// VIDEOS - Only using Scratch Garden (known to work)
const VIDEOS = [
  // AGES 2-3
  { id: 1, title: 'Count and Move', channel: 'Scratch Garden', age: 2, cat: 'songs', youtubeId: '0TgLtF3PMOc' },
  { id: 2, title: 'Days of the Week', channel: 'Scratch Garden', age: 2, cat: 'songs', youtubeId: 'mXMofxtDPUQ' },
  { id: 3, title: 'Months of the Year', channel: 'Scratch Garden', age: 2, cat: 'songs', youtubeId: 'Fe9bnYRzFvk' },
  { id: 4, title: 'Seasons Song', channel: 'Scratch Garden', age: 2, cat: 'songs', youtubeId: '8ZjpI6fgYSY' },
  { id: 5, title: 'Shapes Song', channel: 'Scratch Garden', age: 2, cat: 'counting', youtubeId: 'OEbRDtCAFdU' },
  { id: 6, title: 'Opposite Song', channel: 'Scratch Garden', age: 2, cat: 'colors', youtubeId: 'wiwa7WlRz5I' },
  { id: 7, title: 'Action Verbs', channel: 'Scratch Garden', age: 2, cat: 'movement', youtubeId: 'N7BFSHKWXRY' },
  { id: 8, title: 'Feelings Song', channel: 'Scratch Garden', age: 2, cat: 'movement', youtubeId: 'UsISd1AMNYU' },
  { id: 9, title: 'Good Morning Song', channel: 'Scratch Garden', age: 2, cat: 'songs', youtubeId: 'CuI_p7a9VGs' },
  { id: 10, title: 'Weather Song', channel: 'Scratch Garden', age: 2, cat: 'colors', youtubeId: 'rD6FRDd9Hew' },
  { id: 11, title: 'Animal Sounds', channel: 'Scratch Garden', age: 2, cat: 'animals', youtubeId: 't99ULJjCsaM' },
  { id: 12, title: 'Five Senses', channel: 'Scratch Garden', age: 2, cat: 'animals', youtubeId: 'vXCHzPKPMY0' },
  { id: 13, title: 'ABC Phonics', channel: 'Scratch Garden', age: 2, cat: 'counting', youtubeId: 'BELlZKpi1Zs' },

  // AGES 4-5
  { id: 41, title: 'Water Cycle', channel: 'Scratch Garden', age: 4, cat: 'science', youtubeId: 'TWb4KlM2vts' },
  { id: 42, title: 'Plant Life Cycle', channel: 'Scratch Garden', age: 4, cat: 'science', youtubeId: 'tkFPyue0E0Q' },
  { id: 43, title: 'Solar System', channel: 'Scratch Garden', age: 4, cat: 'science', youtubeId: 'Vb2ZXRh74WU' },
  { id: 44, title: 'Human Body', channel: 'Scratch Garden', age: 4, cat: 'science', youtubeId: 'gQqZVvamsHY' },
  { id: 49, title: 'Sight Words 1', channel: 'Scratch Garden', age: 4, cat: 'reading', youtubeId: 'p7j2PNAF5lk' },
  { id: 50, title: 'Sight Words 2', channel: 'Scratch Garden', age: 4, cat: 'reading', youtubeId: 'ezgHzUFBr1c' },
  { id: 51, title: 'Vowels Song', channel: 'Scratch Garden', age: 4, cat: 'reading', youtubeId: 'e_lGsxSLqE4' },
  { id: 52, title: 'Parts of Speech', channel: 'Scratch Garden', age: 4, cat: 'reading', youtubeId: '4RkZ7o2lmaQ' },
  { id: 57, title: 'Addition Song', channel: 'Scratch Garden', age: 4, cat: 'math', youtubeId: 'qOyo3X9xr4I' },
  { id: 58, title: 'Subtraction Song', channel: 'Scratch Garden', age: 4, cat: 'math', youtubeId: 'QkPa9V2wtZs' },
  { id: 59, title: 'Skip Count by 2', channel: 'Scratch Garden', age: 4, cat: 'math', youtubeId: 'GvTcpfSnOMQ' },
  { id: 60, title: 'Skip Count by 5', channel: 'Scratch Garden', age: 4, cat: 'math', youtubeId: 'amxVL9KUmq8' },
  { id: 65, title: 'Nouns Song', channel: 'Scratch Garden', age: 4, cat: 'arts', youtubeId: 'AVqfg6WadDA' },
  { id: 66, title: 'Verbs Song', channel: 'Scratch Garden', age: 4, cat: 'arts', youtubeId: 'a4fVNsfU1-k' },
  { id: 73, title: 'Good Manners', channel: 'Scratch Garden', age: 4, cat: 'social', youtubeId: 'zf9v1_Yr0jA' },
  { id: 74, title: 'Be Kind', channel: 'Scratch Garden', age: 4, cat: 'social', youtubeId: 'GOzrCZPA7u4' },
  { id: 81, title: 'Life Cycles', channel: 'Scratch Garden', age: 4, cat: 'nature', youtubeId: 'xqq4ORYH4pQ' },
  { id: 82, title: 'Food Chain', channel: 'Scratch Garden', age: 4, cat: 'nature', youtubeId: '9dglXpKsRhQ' },

  // AGES 6-8
  { id: 89, title: 'States of Matter', channel: 'Scratch Garden', age: 6, cat: 'experiments', youtubeId: '9RXW0FRqZkY' },
  { id: 90, title: 'Electricity', channel: 'Scratch Garden', age: 6, cat: 'experiments', youtubeId: 'ru032Mfsfig' },
  { id: 97, title: 'Multiplication', channel: 'Scratch Garden', age: 6, cat: 'math', youtubeId: 'VFnLyZ3mzX0' },
  { id: 98, title: 'Division Song', channel: 'Scratch Garden', age: 6, cat: 'math', youtubeId: 'rGMecZ_aERo' },
  { id: 99, title: 'Fractions Song', channel: 'Scratch Garden', age: 6, cat: 'math', youtubeId: 'n0FZhQ_GkKw' },
  { id: 100, title: 'Telling Time', channel: 'Scratch Garden', age: 6, cat: 'math', youtubeId: 'HrxZWNu72WI' },
  { id: 105, title: 'Solar System', channel: 'Scratch Garden', age: 6, cat: 'space', youtubeId: 'Vb2ZXRh74WU' },
  { id: 106, title: 'The Moon', channel: 'Scratch Garden', age: 6, cat: 'space', youtubeId: '6AviDjR9mGs' },
  { id: 113, title: 'Continents', channel: 'Scratch Garden', age: 6, cat: 'history', youtubeId: 'K6DSMZ8b3LE' },
  { id: 114, title: 'Oceans Song', channel: 'Scratch Garden', age: 6, cat: 'history', youtubeId: 'X6BE4VcYngQ' },
  { id: 121, title: 'Adjectives', channel: 'Scratch Garden', age: 6, cat: 'reading', youtubeId: 'NkuuZEey_bs' },
  { id: 122, title: 'Adverbs Song', channel: 'Scratch Garden', age: 6, cat: 'reading', youtubeId: '97rjEN4QPKw' },
  { id: 129, title: 'Binary Code', channel: 'Scratch Garden', age: 6, cat: 'coding', youtubeId: 'wgbV6DLVezo' },
  { id: 130, title: 'Computer Parts', channel: 'Scratch Garden', age: 6, cat: 'coding', youtubeId: 'Rdm7EIa1_NY' },
];

const QUIZ_INTERVAL = 180; // 3 minutes in seconds
const CATEGORIES = {
  2: { songs: 'üéµ Songs', movement: 'üíÉ Dance', counting: 'üî¢ Numbers', colors: 'üé® Colors', animals: 'üêæ Animals' },
  4: { science: 'üî¨ Science', reading: 'üìñ Reading', math: 'üî¢ Math', arts: 'üé® Art', social: 'ü§ù Social', nature: 'üåø Nature' },
  6: { experiments: 'üß™ Experiments', math: 'üî¢ Math', space: 'üöÄ Space', history: 'üèõÔ∏è History', reading: 'üìö Reading', coding: 'üíª Coding' },
};

const QUESTIONS = {
  2: [
    { q: 'What color is the sun?', answers: ['Yellow', 'Blue', 'Green'], correct: 0, emoji: '‚òÄÔ∏è' },
    { q: 'What sound does a cow make?', answers: ['Woof', 'Moo', 'Meow'], correct: 1, emoji: 'üêÑ' },
    { q: 'How many legs does a dog have?', answers: ['2', '4', '6'], correct: 1, emoji: 'üêï' },
  ],
  4: [
    { q: 'What do plants need to grow?', answers: ['Candy', 'Water and Sun', 'Toys'], correct: 1, emoji: 'üå±' },
    { q: 'How many days in a week?', answers: ['5', '7', '10'], correct: 1, emoji: 'üìÖ' },
    { q: 'What is 2 plus 3?', answers: ['4', '5', '6'], correct: 1, emoji: 'üî¢' },
  ],
  6: [
    { q: 'Which planet is red?', answers: ['Venus', 'Mars', 'Jupiter'], correct: 1, emoji: 'üî¥' },
    { q: 'How many continents?', answers: ['5', '7', '9'], correct: 1, emoji: 'üåç' },
    { q: 'What is 8 times 7?', answers: ['54', '56', '58'], correct: 1, emoji: '‚úñÔ∏è' },
  ],
};

const FREE_CHOICE = [
  { id: 'dinosaurs', label: 'ü¶ñ Dinosaurs', term: 'dinosaurs for kids educational' },
  { id: 'space', label: 'üöÄ Space', term: 'space planets for kids' },
  { id: 'animals', label: 'üêæ Animals', term: 'animals for kids learning' },
  { id: 'science', label: 'üî¨ Science', term: 'science experiments kids' },
];

// TTS
const useSpeech = () => {
  const speak = (text) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.9;
      window.speechSynthesis.speak(u);
    }
  };
  return { speak };
};

// Avatars
const Fox = ({size=60, happy}) => <svg viewBox="0 0 80 80" width={size} height={size}><circle cx="40" cy="42" r="32" fill="#FF9A5C"/><polygon points="12,20 25,45 5,40" fill="#FF9A5C"/><polygon points="68,20 55,45 75,40" fill="#FF9A5C"/><ellipse cx="40" cy="52" rx="18" ry="14" fill="#FFD4B8"/><circle cx="30" cy="38" r="6" fill="#333"/><circle cx="50" cy="38" r="6" fill="#333"/><ellipse cx="40" cy="48" rx="4" ry="3" fill="#333"/>{happy && <ellipse cx="40" cy="58" rx="6" ry="5" fill="#333"/>}</svg>;
const Bunny = ({size=60}) => <svg viewBox="0 0 80 80" width={size} height={size}><circle cx="40" cy="48" r="28" fill="#FFB6C1"/><ellipse cx="25" cy="18" rx="10" ry="24" fill="#FFB6C1"/><ellipse cx="55" cy="18" rx="10" ry="24" fill="#FFB6C1"/><circle cx="30" cy="45" r="5" fill="#333"/><circle cx="50" cy="45" r="5" fill="#333"/><ellipse cx="40" cy="54" rx="4" ry="2.5" fill="#FF8A80"/></svg>;
const Owl = ({size=60}) => <svg viewBox="0 0 80 80" width={size} height={size}><circle cx="40" cy="44" r="30" fill="#8D6E63"/><ellipse cx="40" cy="46" rx="22" ry="20" fill="#D7CCC8"/><circle cx="30" cy="42" r="10" fill="#FFF"/><circle cx="50" cy="42" r="10" fill="#FFF"/><circle cx="30" cy="42" r="5" fill="#333"/><circle cx="50" cy="42" r="5" fill="#333"/><polygon points="40,50 35,58 45,58" fill="#FF9800"/></svg>;
const Panda = ({size=60}) => <svg viewBox="0 0 80 80" width={size} height={size}><circle cx="40" cy="44" r="30" fill="#FFF"/><circle cx="16" cy="22" r="10" fill="#333"/><circle cx="64" cy="22" r="10" fill="#333"/><ellipse cx="28" cy="40" rx="11" ry="13" fill="#333"/><ellipse cx="52" cy="40" rx="11" ry="13" fill="#333"/><circle cx="28" cy="40" r="6" fill="#FFF"/><circle cx="52" cy="40" r="6" fill="#FFF"/><circle cx="28" cy="40" r="3" fill="#333"/><circle cx="52" cy="40" r="3" fill="#333"/><ellipse cx="40" cy="52" rx="6" ry="4" fill="#333"/></svg>;
const avatars = [Fox, Bunny, Owl, Panda];
const avatarNames = ['Foxy', 'Bun Bun', 'Ollie', 'Pan Pan'];

// Question Modal
const QuestionModal = ({ question, onAnswer }) => {
  const [sel, setSel] = useState(null);
  const [done, setDone] = useState(false);
  const { speak } = useSpeech();
  useEffect(() => { speak(question.q); }, []);
  const pick = (i) => { setSel(i); setDone(true); speak(i === question.correct ? "That's right!" : "Good try!"); setTimeout(() => onAnswer(i === question.correct), 2000); };
  return (
    <div className="fixed inset-0 bg-gradient-to-b from-indigo-600 via-purple-600 to-pink-600 flex items-center justify-center z-50 p-4">
      <div className="max-w-lg w-full text-center">
        {!done ? (<>
          <div className="text-8xl mb-6">{question.emoji}</div>
          <h2 className="text-3xl font-bold text-white mb-6">{question.q}</h2>
          <button onClick={() => speak(question.q)} className="px-5 py-2 bg-white/20 rounded-full text-white mb-8"><Volume2 className="w-5 h-5 inline mr-2"/>Read to me</button>
          <div className="space-y-3">{question.answers.map((a,i) => <button key={i} onClick={() => pick(i)} className="w-full py-4 rounded-2xl bg-white/20 hover:bg-white text-white hover:text-indigo-600 text-xl font-bold transition-all">{a}</button>)}</div>
        </>) : (<>
          <div className="text-9xl mb-6">{sel === question.correct ? '‚≠ê' : 'üòÖ'}</div>
          <h2 className="text-4xl font-bold text-white">{sel === question.correct ? 'You got it!' : 'So close!'}</h2>
        </>)}
      </div>
    </div>
  );
};

const JarFullModal = ({ name, onClaim }) => (
  <div className="fixed inset-0 bg-gradient-to-b from-amber-500 via-orange-500 to-rose-500 flex items-center justify-center z-50 p-4">
    <div className="text-center">
      <div className="text-9xl mb-4">üéâ</div>
      <h2 className="text-4xl font-bold text-white mb-3">Bonus Unlocked!</h2>
      <p className="text-2xl text-white/90 mb-8">Way to go, {name}!</p>
      <button onClick={onClaim} className="px-10 py-5 bg-white text-orange-500 font-bold text-xl rounded-2xl shadow-xl hover:scale-105 transition-transform">üé¨ Pick a bonus topic!</button>
    </div>
  </div>
);

const FreeChoiceSelector = ({ onSelect, onCancel }) => {
  const [cat, setCat] = useState(null);
  return (
    <div className="fixed inset-0 bg-gradient-to-b from-purple-600 via-indigo-600 to-blue-600 flex items-center justify-center z-50 p-4">
      <div className="max-w-xl w-full text-center">
        <div className="text-7xl mb-4">üéÅ</div>
        <h2 className="text-3xl font-bold text-white mb-8">Pick a bonus topic!</h2>
        <div className="grid grid-cols-2 gap-4 mb-8">{FREE_CHOICE.map(c => <button key={c.id} onClick={() => setCat(c)} className={`p-6 rounded-2xl flex flex-col items-center justify-center transition-all ${cat?.id === c.id ? 'bg-white scale-105 shadow-xl' : 'bg-white/20 hover:bg-white/30'}`}><span className="text-4xl mb-2">{c.label.split(' ')[0]}</span><span className={`font-bold ${cat?.id === c.id ? 'text-purple-600' : 'text-white'}`}>{c.label.split(' ')[1]}</span></button>)}</div>
        <div className="flex gap-3">
          <button onClick={onCancel} className="flex-1 py-4 rounded-xl bg-white/20 text-white font-bold">Later</button>
          <button onClick={() => cat && onSelect(cat)} disabled={!cat} className="flex-1 py-4 rounded-xl bg-white text-purple-600 font-bold disabled:opacity-50">Watch!</button>
        </div>
      </div>
    </div>
  );
};

const FreeChoicePlayer = ({ choice, onDone }) => {
  const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(choice.term)}`;
  return (
    <div className="fixed inset-0 bg-gradient-to-b from-amber-500 via-orange-500 to-rose-500 z-50 flex flex-col items-center justify-center p-4">
      <div className="bg-white rounded-3xl p-8 max-w-lg text-center shadow-2xl">
        <div className="text-6xl mb-4">üé¨</div>
        <h2 className="text-2xl font-bold text-gray-800 mb-4">{choice.label}</h2>
        <a href={searchUrl} target="_blank" rel="noopener noreferrer" className="inline-block px-8 py-4 bg-red-500 text-white font-bold text-lg rounded-2xl mb-4">‚ñ∂Ô∏è Open YouTube</a>
        <br/><button onClick={onDone} className="text-gray-500 hover:text-gray-700">Done watching</button>
      </div>
    </div>
  );
};

// YouTube Player - POLLS actual playback position from YouTube API
const YouTubePlayer = ({ video, onBack, onQuizTime, rewards }) => {
  const [currentTime, setCurrentTime] = useState(0);
  const [lastTime, setLastTime] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [error, setError] = useState(null);
  const [apiReady, setApiReady] = useState(false);
  const playerRef = useRef(null);
  const pollRef = useRef(null);
  const playerId = useRef(`yt-${Date.now()}`);
  const lastQuizRef = useRef(0);

  // Load YouTube API
  useEffect(() => {
    if (window.YT && window.YT.Player) {
      setApiReady(true);
      return;
    }

    // Load the API
    if (!document.getElementById('youtube-api')) {
      const tag = document.createElement('script');
      tag.id = 'youtube-api';
      tag.src = 'https://www.youtube.com/iframe_api';
      document.head.appendChild(tag);
    }

    window.onYouTubeIframeAPIReady = () => setApiReady(true);
  }, []);

  // Create player when API is ready
  useEffect(() => {
    if (!apiReady) return;

    // Destroy old player
    if (playerRef.current) {
      try { playerRef.current.destroy(); } catch(e) {}
    }

    // Reset state
    setCurrentTime(0);
    setLastTime(0);
    lastQuizRef.current = 0;
    setError(null);

    // Create player
    playerRef.current = new window.YT.Player(playerId.current, {
      videoId: video.youtubeId,
      playerVars: { autoplay: 1, modestbranding: 1, rel: 0, playsinline: 1 },
      events: {
        onStateChange: (e) => {
          // 1=playing, 2=paused, 0=ended, 3=buffering
          setIsPlaying(e.data === 1);
          console.log('YouTube state:', e.data);
        },
        onError: (e) => {
          console.error('YouTube error:', e.data);
          setError(`Video error (${e.data})`);
        }
      }
    });

    return () => {
      if (pollRef.current) clearInterval(pollRef.current);
      if (playerRef.current) try { playerRef.current.destroy(); } catch(e) {}
    };
  }, [apiReady, video.youtubeId]);

  // Poll YouTube's actual current time - THE KEY FIX
  useEffect(() => {
    pollRef.current = setInterval(() => {
      if (playerRef.current && playerRef.current.getCurrentTime) {
        try {
          const ytTime = Math.floor(playerRef.current.getCurrentTime());
          const state = playerRef.current.getPlayerState();
          
          // Only count time when actually playing (state 1)
          if (state === 1) {
            setCurrentTime(ytTime);
            
            // Check for quiz
            if (rewards && ytTime - lastQuizRef.current >= QUIZ_INTERVAL) {
              lastQuizRef.current = ytTime;
              playerRef.current.pauseVideo();
              onQuizTime();
            }
          }
          
          setIsPlaying(state === 1);
        } catch(e) {
          // Player not ready yet
        }
      }
    }, 500); // Poll every 500ms

    return () => {
      if (pollRef.current) clearInterval(pollRef.current);
    };
  }, [rewards, onQuizTime]);

  // Resume after quiz
  window.resumeKindiVideo = () => {
    if (playerRef.current?.playVideo) playerRef.current.playVideo();
  };

  const fmt = s => `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
  const nextQuiz = QUIZ_INTERVAL - (currentTime - lastQuizRef.current);

  return (
    <div className="space-y-4">
      <button onClick={onBack} className="px-4 py-2 bg-white hover:bg-gray-50 rounded-full font-medium text-gray-600 flex items-center gap-2 shadow-md">
        <ArrowLeft className="w-4 h-4"/>Back to Videos
      </button>

      <div className="bg-white rounded-3xl overflow-hidden shadow-2xl">
        <div className="relative aspect-video bg-black">
          {error ? (
            <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 text-white p-4">
              <div className="text-6xl mb-4">üòî</div>
              <p className="text-xl font-bold mb-2">Video unavailable</p>
              <p className="text-gray-400 mb-4">{error}</p>
              <button onClick={onBack} className="px-6 py-2 bg-white text-gray-800 rounded-full font-bold">Pick another</button>
            </div>
          ) : (
            <div id={playerId.current} className="w-full h-full"></div>
          )}
          
          {/* Quiz countdown */}
          {rewards && !error && nextQuiz <= 30 && nextQuiz > 0 && (
            <div className="absolute top-4 right-4 bg-gradient-to-r from-orange-500 to-red-500 rounded-full px-4 py-2 flex items-center gap-2 shadow-lg animate-pulse z-10">
              <Sparkles className="w-4 h-4 text-yellow-300"/>
              <span className="text-white font-bold text-sm">Quiz in {nextQuiz}s! üéØ</span>
            </div>
          )}
        </div>
        
        {/* Info bar */}
        <div className="p-4 flex items-center justify-between border-t bg-gray-50">
          <div className="flex-1 min-w-0">
            <h3 className="font-bold text-gray-800 truncate">{video.title}</h3>
            <p className="text-sm text-gray-500">{video.channel}</p>
          </div>
          <div className="flex items-center gap-3 ml-4">
            <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium ${isPlaying ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
              {isPlaying ? <Play className="w-3 h-3"/> : <Pause className="w-3 h-3"/>}
              {isPlaying ? 'Playing' : 'Paused'}
            </div>
            <div className="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full text-sm font-bold">
              ‚è±Ô∏è {fmt(currentTime)}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const VideoThumbnail = ({ video, onClick }) => {
  const [imgError, setImgError] = useState(false);
  return (
    <button onClick={onClick} className="group text-left rounded-2xl overflow-hidden bg-white shadow-md hover:shadow-xl hover:scale-105 transition-all">
      <div className="relative aspect-video bg-gradient-to-br from-purple-400 to-pink-400">
        {!imgError ? (
          <img src={`https://img.youtube.com/vi/${video.youtubeId}/mqdefault.jpg`} alt={video.title} className="w-full h-full object-cover" onError={() => setImgError(true)}/>
        ) : (
          <div className="w-full h-full flex items-center justify-center text-white"><span className="text-5xl">üé¨</span></div>
        )}
        <div className="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
          <div className="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-lg"><Play className="w-5 h-5 text-gray-700"/></div>
        </div>
      </div>
      <div className="p-3 bg-white">
        <h3 className="font-bold text-sm text-gray-800 line-clamp-2">{video.title}</h3>
        <p className="text-xs text-gray-500 mt-1">{video.channel}</p>
      </div>
    </button>
  );
};

const VideoGrid = ({ videos, onSelect }) => (
  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    {videos.map(v => <VideoThumbnail key={v.id} video={v} onClick={() => onSelect(v)} />)}
  </div>
);

const ChildModal = ({ child, onSave, onClose }) => {
  const [name, setName] = useState(child?.name || '');
  const [age, setAge] = useState(child?.age || 4);
  const [av, setAv] = useState(child?.avatar || 0);
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-3xl p-8 max-w-md w-full">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold">{child ? 'Edit' : 'Add'} Profile</h2>
          <button onClick={onClose}><X className="w-5 h-5 text-gray-500"/></button>
        </div>
        <div className="flex gap-3 justify-center mb-6">
          {avatars.map((A,i) => <button key={i} onClick={() => setAv(i)} className={`p-2 rounded-xl ${av === i ? 'bg-indigo-100 ring-2 ring-indigo-400' : ''}`}><A size={50}/><span className="text-xs text-gray-500 block">{avatarNames[i]}</span></button>)}
        </div>
        <input value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-lg mb-4" placeholder="Name"/>
        <div className="mb-6"><span className="text-sm text-gray-600">Age: {age}</span><input type="range" min="2" max="8" value={age} onChange={e => setAge(+e.target.value)} className="w-full mt-2"/></div>
        <div className="flex gap-3">
          <button onClick={onClose} className="flex-1 py-3 rounded-xl border-2 border-gray-200 font-bold text-gray-600">Cancel</button>
          <button onClick={() => name.trim() && (onSave({id: child?.id || Date.now(), name, age, avatar: av}), onClose())} className="flex-1 py-3 rounded-xl bg-indigo-500 font-bold text-white">{child ? 'Save' : 'Add'}</button>
        </div>
      </div>
    </div>
  );
};

// Setup Page
const SetupPage = ({ kids, onStart, onAdd, onEdit }) => {
  const [step, setStep] = useState(1);
  const [sel, setSel] = useState(null);
  const [dur, setDur] = useState(30);
  const [cats, setCats] = useState([]);
  const [modal, setModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [rewards, setRewards] = useState(true);
  const [goal, setGoal] = useState(5);

  const ageGroup = sel ? (sel.age <= 3 ? 2 : sel.age <= 5 ? 4 : 6) : null;
  const avail = ageGroup ? Object.entries(CATEGORIES[ageGroup]) : [];
  const canGo = () => step === 1 ? sel : step === 2 ? cats.length > 0 : true;
  const next = () => step === 3 ? onStart(sel, dur, cats, {enabled: rewards, goal}) : setStep(step + 1);

  return (
    <div className="min-h-screen bg-gradient-to-b from-indigo-500 via-purple-500 to-pink-500 flex flex-col relative overflow-hidden">
      <div className="absolute inset-0 pointer-events-none"><div className="absolute top-20 -left-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"/><div className="absolute top-1/3 -right-20 w-60 h-60 bg-white/10 rounded-full blur-3xl"/></div>
      
      <div className="relative z-10 px-6 pt-6 pb-2 flex items-center justify-between">
        <div className="flex items-center gap-2"><div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center"><span className="text-xl">ü¶ä</span></div><span className="text-xl font-bold text-white">kindi</span></div>
        <button onClick={() => { setEditing(null); setModal(true); }} className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30"><Plus className="w-5 h-5 text-white"/></button>
      </div>
      
      <div className="relative z-10 flex-1 flex flex-col justify-center px-6 py-6 max-w-xl mx-auto w-full">
        {step === 1 && (
          <div className="text-center">
            <h1 className="text-3xl font-bold text-white mb-2">Who's watching?</h1>
            <p className="text-white/70 mb-10">Tap to choose</p>
            <div className="flex justify-center gap-6 flex-wrap">
              {kids.map(k => { const A = avatars[k.avatar || 0]; return (
                <button key={k.id} onClick={() => { setSel(k); setCats([]); }} className={`relative transition-all ${sel?.id === k.id ? 'scale-110' : 'opacity-70 hover:opacity-100'}`}>
                  <div className={`w-20 h-20 rounded-2xl flex items-center justify-center ${sel?.id === k.id ? 'bg-white shadow-xl' : 'bg-white/20'}`}><A size={50} happy={sel?.id === k.id}/></div>
                  <p className={`mt-3 font-semibold ${sel?.id === k.id ? 'text-white' : 'text-white/70'}`}>{k.name}</p>
                  <p className={`text-sm ${sel?.id === k.id ? 'text-white/80' : 'text-white/50'}`}>{k.age} years</p>
                </button>
              );})}
            </div>
          </div>
        )}
        
        {step === 2 && (
          <div className="text-center">
            <h1 className="text-3xl font-bold text-white mb-2">Pick adventures</h1>
            <p className="text-white/70 mb-8">What sounds fun?</p>
            <div className="grid grid-cols-3 gap-3">
              {avail.map(([k, l]) => { const isSel = cats.includes(k); return (
                <button key={k} onClick={() => setCats(p => p.includes(k) ? p.filter(c => c !== k) : [...p, k])} className={`aspect-square rounded-2xl flex flex-col items-center justify-center transition-all ${isSel ? 'bg-white shadow-xl scale-105' : 'bg-white/20 hover:bg-white/30'}`}>
                  <span className="text-2xl mb-1">{l.split(' ')[0]}</span>
                  <span className={`text-xs font-semibold ${isSel ? 'text-indigo-600' : 'text-white'}`}>{l.split(' ').slice(1).join(' ')}</span>
                </button>
              );})}
            </div>
          </div>
        )}
        
        {step === 3 && (
          <div className="text-center">
            <h1 className="text-3xl font-bold text-white mb-2">Set it up</h1>
            <div className="bg-white/20 rounded-2xl p-5 mb-4">
              <p className="text-white/80 text-sm mb-3"><Clock className="w-4 h-4 inline mr-2"/>Duration</p>
              <div className="flex gap-2">{[15,30,45,60].map(m => <button key={m} onClick={() => setDur(m)} className={`flex-1 py-3 rounded-xl font-bold ${dur === m ? 'bg-white text-indigo-600' : 'bg-white/20 text-white'}`}>{m}m</button>)}</div>
            </div>
            <div className="bg-white/20 rounded-2xl p-5 mb-4">
              <button onClick={() => setRewards(!rewards)} className={`flex items-center gap-2 px-4 py-2 rounded-full mx-auto mb-3 ${rewards ? 'bg-amber-400 text-amber-900' : 'bg-white/20 text-white'}`}><Star className="w-4 h-4"/><span className="font-bold text-sm">Star Rewards</span></button>
              {rewards && (<><p className="text-white/80 text-sm mb-3">Stars for bonus</p><div className="flex gap-2">{[3,5,10].map(n => <button key={n} onClick={() => setGoal(n)} className={`flex-1 py-3 rounded-xl font-bold ${goal === n ? 'bg-amber-400 text-amber-900' : 'bg-white/20 text-white'}`}>{n} ‚≠ê</button>)}</div></>)}
            </div>
          </div>
        )}
      </div>
      
      <div className="relative z-10 px-6 pb-8 max-w-xl mx-auto w-full">
        <div className="flex justify-center gap-2 mb-4">{[1,2,3].map(s => <button key={s} onClick={() => s < step && setStep(s)} className={`h-2 rounded-full ${step === s ? 'w-8 bg-white' : s < step ? 'w-2 bg-white/60' : 'w-2 bg-white/30'}`}/>)}</div>
        <div className="flex gap-3">
          {step > 1 && <button onClick={() => setStep(step-1)} className="flex-1 py-4 bg-white/20 text-white font-bold rounded-2xl">Back</button>}
          <button onClick={next} disabled={!canGo()} className="flex-1 py-4 bg-white text-indigo-600 font-bold rounded-2xl shadow-xl disabled:opacity-50">{step === 3 ? "Let's Go! üöÄ" : 'Next'}</button>
        </div>
      </div>
      
      {modal && <ChildModal child={editing} onSave={editing ? onEdit : onAdd} onClose={() => { setModal(false); setEditing(null); }}/>}
    </div>
  );
};

// Watch Page
const WatchPage = ({ child, duration, categories, rewards, onEnd }) => {
  const [video, setVideo] = useState(null);
  const [timeUp, setTimeUp] = useState(false);
  const [active, setActive] = useState(categories);
  const [stars, setStars] = useState(0);
  const [question, setQuestion] = useState(null);
  const [jarFull, setJarFull] = useState(false);
  const [freeChoice, setFreeChoice] = useState(false);
  const [freePlay, setFreePlay] = useState(null);
  const [sessionTime, setSessionTime] = useState(duration * 60);

  const ageGroup = child.age <= 3 ? 2 : child.age <= 5 ? 4 : 6;
  const allCats = CATEGORIES[ageGroup];
  const availCats = categories.map(k => [k, allCats[k]]);
  const videos = VIDEOS.filter(v => v.age === ageGroup && active.includes(v.cat));
  const questions = QUESTIONS[ageGroup];
  const A = avatars[child.avatar || 0];
  const fmt = s => `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;

  // Session timer
  useEffect(() => { 
    const t = setInterval(() => setSessionTime(p => { 
      if (p <= 1) { clearInterval(t); setTimeUp(true); return 0; } 
      return p - 1; 
    }), 1000); 
    return () => clearInterval(t); 
  }, []);
  
  const onQuizTime = () => { 
    if (rewards.enabled) setQuestion(questions[Math.floor(Math.random() * questions.length)]); 
  };
  
  const onAnswer = (correct) => { 
    setQuestion(null); 
    if (correct) { 
      const n = stars + 1; 
      setStars(n); 
      if (n >= rewards.goal) setTimeout(() => setJarFull(true), 500); 
    }
    // Resume video
    if (window.resumeKindiVideo) window.resumeKindiVideo();
  };

  if (freePlay) return <FreeChoicePlayer choice={freePlay} onDone={() => setFreePlay(null)}/>;

  return (
    <div className="min-h-screen bg-gradient-to-b from-indigo-100 via-purple-50 to-pink-50">
      <div className="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 shadow-lg sticky top-0 z-40">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-2"><div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center"><span className="text-lg">ü¶ä</span></div><span className="text-lg font-bold text-white">kindi</span></div>
          <div className="flex items-center gap-2">
            <div className="bg-white/20 rounded-full px-3 py-1.5 flex items-center gap-1.5"><Clock className="w-4 h-4 text-white"/><span className="font-bold text-white">{fmt(sessionTime)}</span></div>
            {rewards.enabled && <div className="bg-amber-400 rounded-full px-3 py-1.5 flex items-center gap-1.5"><Star className="w-4 h-4 text-amber-900"/><span className="font-bold text-amber-900">{stars}/{rewards.goal}</span></div>}
            <div className="bg-white/20 rounded-full pl-1 pr-3 py-1 flex items-center gap-1.5"><A size={26}/><span className="text-white font-medium text-sm">{child.name}</span></div>
            <button onClick={onEnd} className="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-full font-medium text-white text-sm">End</button>
          </div>
        </div>
      </div>
      
      {availCats.length > 1 && (
        <div className="bg-white/80 border-b">
          <div className="max-w-6xl mx-auto px-4 py-2 flex items-center gap-2 overflow-x-auto">
            <span className="text-sm text-purple-600 font-medium">Show:</span>
            {availCats.map(([k,l]) => <button key={k} onClick={() => setActive(p => p.includes(k) ? p.filter(c => c !== k) : [...p, k])} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap ${active.includes(k) ? 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white' : 'bg-white text-gray-600'}`}>{l}</button>)}
          </div>
        </div>
      )}
      
      <div className="max-w-6xl mx-auto px-4 py-6">
        {!video ? (
          <>
            <h1 className="text-xl font-bold text-indigo-900 mb-4">{videos.length} videos to explore! üéâ</h1>
            {videos.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üé¨</div>
                <p className="text-gray-500">No videos in selected categories</p>
              </div>
            ) : (
              <VideoGrid videos={videos} onSelect={setVideo}/>
            )}
          </>
        ) : (
          <div className="max-w-3xl mx-auto space-y-6">
            <YouTubePlayer video={video} onBack={() => setVideo(null)} onQuizTime={onQuizTime} rewards={rewards.enabled}/>
            
            {videos.filter(v => v.id !== video.id).length > 0 && (
              <div className="bg-white rounded-2xl p-4 shadow-md">
                <h3 className="text-lg font-bold text-gray-800 mb-3">Up Next üé¨</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {videos.filter(v => v.id !== video.id).slice(0,4).map(v => (
                    <button key={v.id} onClick={() => setVideo(v)} className="rounded-xl overflow-hidden shadow-sm hover:shadow-md hover:scale-105 transition-all">
                      <div className="aspect-video bg-gray-200">
                        <img src={`https://img.youtube.com/vi/${v.youtubeId}/mqdefault.jpg`} alt="" className="w-full h-full object-cover" onError={(e) => e.target.style.display='none'}/>
                      </div>
                      <div className="p-2 bg-white"><p className="text-xs font-medium text-gray-700 truncate">{v.title}</p></div>
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>
      
      {question && <QuestionModal question={question} onAnswer={onAnswer}/>}
      {jarFull && <JarFullModal name={child.name} onClaim={() => { setJarFull(false); setFreeChoice(true); }}/>}
      {freeChoice && <FreeChoiceSelector onSelect={c => { setFreeChoice(false); setFreePlay(c); setStars(0); }} onCancel={() => setFreeChoice(false)}/>}
      {timeUp && (
        <div className="fixed inset-0 bg-gradient-to-b from-amber-500 to-rose-500 flex items-center justify-center z-50 p-4">
          <div className="text-center">
            <Trophy className="w-20 h-20 text-white mx-auto mb-4"/>
            <h2 className="text-4xl font-bold text-white mb-3">Time's up! üéâ</h2>
            <p className="text-2xl text-white/90 mb-6">{child.name} had {duration} min of fun!</p>
            <button onClick={onEnd} className="px-10 py-4 bg-white text-orange-500 font-bold text-xl rounded-2xl shadow-xl hover:scale-105">All Done! ‚ú®</button>
          </div>
        </div>
      )}
    </div>
  );
};

// Main App
function App() {
  const [kids, setKids] = useState([{ id: 1, name: 'Nico', age: 5, avatar: 0 }, { id: 2, name: 'Adri', age: 3, avatar: 1 }]);
  const [session, setSession] = useState(null);
  
  if (session) return <WatchPage child={session.child} duration={session.duration} categories={session.categories} rewards={session.rewards} onEnd={() => setSession(null)}/>;
  return <SetupPage kids={kids} onStart={(c,d,cats,r) => setSession({child:c,duration:d,categories:cats,rewards:r})} onAdd={k => setKids([...kids, k])} onEdit={k => setKids(kids.map(x => x.id === k.id ? k : x))}/>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
